<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Zone Planner | Vimtra Group</title>
    <link rel="stylesheet" href="../css/styles.css">
    <!-- Luxon for Time Zones -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <!-- PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --slot-width: 40px;
            --slot-height: 50px;
            --business-start: 9;
            --business-end: 18;
        }

        .planner-workspace {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-top: 20px;
            overflow-x: auto;
        }

        .controls-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .zone-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
        }

        .zone-header {
            background: #f8f9fa;
            padding: 15px;
            font-weight: 600;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .timeline-header {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .time-label {
            width: var(--slot-width);
            text-align: center;
            font-size: 0.75rem;
            color: #666;
            padding: 10px 0;
            border-right: 1px solid #f0f0f0;
            flex-shrink: 0;
        }

        .zone-row {
            display: contents;
        }

        .location-info {
            padding: 15px;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
            background: white;
        }

        .location-name {
            font-weight: 600;
            display: block;
            color: var(--secondary);
        }

        .location-time {
            font-size: 0.85em;
            color: #666;
        }

        .location-remove {
            color: #ef4444;
            cursor: pointer;
            font-size: 0.8em;
            margin-top: 5px;
            text-decoration: underline;
        }

        .timeline-track {
            display: flex;
            border-bottom: 1px solid #eee;
            position: relative;
            background: white;
        }

        .time-slot {
            width: var(--slot-width);
            height: var(--slot-height);
            border-right: 1px solid #f0f0f0;
            flex-shrink: 0;
            transition: background 0.2s;
            cursor: pointer;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
        }

        .time-slot.business-hours {
            background-color: #ecfdf5;
            /* Light Green */
        }

        .time-slot.night-hours {
            background-color: #f8fafc;
        }

        .time-slot.selected {
            background-color: rgba(6, 182, 212, 0.2);
            /* Cyan tint */
            border-top: 2px solid var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .time-slot.overlap-warning {
            background-color: #fef2f2;
            /* Light Red */
        }

        .time-slot.good-overlap {
            background-color: #d1fae5;
            /* Stronger Green */
            border: 1px solid #34d399;
        }

        /* Meeting Overlay */
        .meeting-overlay {
            position: absolute;
            top: 0;
            bottom: 0;
            background: rgba(13, 148, 136, 0.2);
            border: 2px solid var(--primary);
            border-radius: 4px;
            pointer-events: none;
            display: none;
        }

        .meeting-details-panel {
            background: #f8f9fa;
            border: 1px solid #eee;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            display: none;
        }

        .selected-time-display {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
        }

        @media (max-width: 800px) {
            .zone-grid {
                grid-template-columns: 120px 1fr;
            }

            :root {
                --slot-width: 30px;
            }
        }
    </style>
</head>

<body class="theme-vimtra">

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="../index.html" class="logo-container" style="text-decoration: none;">
                    <img src="../logos/Vimtra Ventures.png" alt="Vimtra Ventures" class="logo-img">
                    <span class="app-title">Custom Tools</span>
                </a>
                <a href="../index.html" class="btn btn-secondary" style="margin-left: auto;">Back to Tools</a>
            </div>
        </div>
    </header>

    <main>
        <section class="tools-section">
            <div class="container">
                <div class="section-header">
                    <h1 class="section-title">Time Zone Planner</h1>
                    <p class="section-subtitle">Find the perfect meeting time across global teams.</p>
                </div>

                <!-- Controls -->
                <div class="controls-bar">
                    <div class="form-group" style="margin-bottom: 0;">
                        <input type="date" id="meetingDate" class="form-input">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <select id="addZoneSelect" class="form-select" style="min-width: 200px;">
                            <option value="">+ Add Location...</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="resetPlanner()">Reset</button>
                    <button class="btn btn-primary" style="margin-left: auto;" onclick="exportPDF()">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"
                            style="margin-right:8px; vertical-align:text-bottom;">
                            <path
                                d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H8V4h12v12zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm12 6V9c0-.55-.45-1-1-1h-2v5h2c.55 0 1-.45 1-1zm-2-3h1v3h-1V9zm-4 5h1v-1h1v1h1v-2h-1v-1h1V9H9v5z" />
                        </svg>
                        Export PDF
                    </button>
                </div>

                <!-- Planner Grid -->
                <div id="plannerContainer">
                    <div class="planner-workspace" id="scheduleTable">
                        <div class="zone-grid" id="zoneGrid">
                            <!-- Headers -->
                            <div class="zone-header">Location</div>
                            <div class="timeline-header" id="timelineHeader">
                                <!-- 00-23 hours populated by JS -->
                            </div>

                            <!-- Rows populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Meeting Details -->
                <div class="meeting-details-panel" id="meetingPanel">
                    <div class="selected-time-display" id="selectedTimeText">No time selected</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label">Meeting Title</label>
                            <input type="text" id="meetingTitle" class="form-input" placeholder="e.g. Weekly Sync">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Meeting Link</label>
                            <input type="text" id="meetingLink" class="form-input" placeholder="Zoom/Teams URL">
                        </div>
                    </div>
                    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                        <span
                            style="display:inline-block; width:12px; height:12px; background:#d1fae5; border:1px solid #34d399; margin-right:5px;"></span>
                        Good Overlap
                        <span
                            style="display:inline-block; width:12px; height:12px; background:#fef2f2; border:1px solid #ef4444; margin-right:5px; margin-left:15px;"></span>
                        Outside Hours
                    </p>
                </div>

            </div>
        </section>
    </main>

    <script src="../js/app.js"></script>
    <script>
        const DateTime = luxon.DateTime;

        // Configuration
        const commonZones = [
            { name: "India (IST)", zone: "Asia/Kolkata" },
            { name: "New York (EST)", zone: "America/New_York" },
            { name: "London (GMT)", zone: "Europe/London" },
            { name: "California (PST)", zone: "America/Los_Angeles" },
            { name: "Dubai (GST)", zone: "Asia/Dubai" },
            { name: "Singapore (SGT)", zone: "Asia/Singapore" },
            { name: "Sydney (AEST)", zone: "Australia/Sydney" },
            { name: "Tokyo (JST)", zone: "Asia/Tokyo" }
        ];

        let activeZones = [];
        let selectedHour = null; // 0-23 based on first zone

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Set Date to Today
            document.getElementById('meetingDate').value = DateTime.now().toISODate();

            // Populate Dropdown
            const select = document.getElementById('addZoneSelect');
            commonZones.forEach(z => {
                const opt = document.createElement('option');
                opt.value = z.zone;
                opt.textContent = z.name;
                select.appendChild(opt);
            });

            select.addEventListener('change', (e) => {
                if (e.target.value) {
                    addZone(e.target.value);
                    e.target.value = "";
                }
            });

            // Date Change
            document.getElementById('meetingDate').addEventListener('change', renderGrid);

            // Default Zones
            addZone(DateTime.now().zoneName); // Local
            addZone("America/New_York");
            addZone("Europe/London");
        });

        function addZone(zoneName) {
            // Find pretty name or use raw
            let name = commonZones.find(z => z.zone === zoneName)?.name || zoneName.split('/')[1].replace('_', ' ');
            if (activeZones.find(z => z.zone === zoneName)) return; // Prevent duplicates

            activeZones.push({ name, zone: zoneName });
            renderGrid();
        }

        function removeZone(index) {
            activeZones.splice(index, 1);
            renderGrid();
        }

        function resetPlanner() {
            activeZones = [];
            addZone(DateTime.now().zoneName);
            renderGrid();
            document.getElementById('meetingPanel').style.display = 'none';
            selectedHour = null;
        }

        function renderGrid() {
            const grid = document.getElementById('zoneGrid');
            const dateStr = document.getElementById('meetingDate').value;
            const baseDate = DateTime.fromISO(dateStr);

            // Clear existing rows (keep header)
            while (grid.children.length > 2) {
                grid.removeChild(grid.lastChild);
            }

            // Render Header Hours (0-23)
            const timeHeader = document.getElementById('timelineHeader');
            timeHeader.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const div = document.createElement('div');
                div.className = 'time-label';
                div.textContent = `${i}:00`;
                timeHeader.appendChild(div);
            }

            // Render Rows
            activeZones.forEach((loc, idx) => {
                // Info Cell
                const infoDiv = document.createElement('div');
                infoDiv.className = 'location-info';

                const timeInZone = baseDate.setZone(loc.zone);
                const offset = timeInZone.toFormat("'GMT'ZZ");

                infoDiv.innerHTML = `
                    <span class="location-name">${loc.name}</span>
                    <span class="location-time">${offset}</span>
                    ${idx > 0 ? `<div class="location-remove" onclick="removeZone(${idx})">Remove</div>` : ''}
                `;
                grid.appendChild(infoDiv);

                // Timeline Track
                const trackDiv = document.createElement('div');
                trackDiv.className = 'timeline-track';

                for (let h = 0; h < 24; h++) {
                    const slotTime = baseDate.set({ hour: h }).setZone(loc.zone);
                    const localHour = slotTime.hour;

                    const slot = document.createElement('div');
                    slot.className = 'time-slot';
                    slot.textContent = localHour;
                    slot.dataset.globalHour = h; // Store base hour index

                    // Business Hours Logic (9am - 6pm)
                    if (localHour >= 9 && localHour <= 17) {
                        slot.classList.add('business-hours');
                    } else {
                        slot.classList.add('night-hours');
                    }

                    // Selection Event
                    slot.addEventListener('click', () => selectTime(h));

                    // Highlight Selected
                    if (selectedHour === h) {
                        slot.classList.add('selected');
                        // Color Logic based on overlap
                        // We check overlap dynamically in visual update, but simplistic here:
                        // If selected and outside business hours -> Red Warning
                        if (localHour < 8 || localHour > 19) {
                            slot.classList.add('overlap-warning');
                        } else {
                            slot.classList.add('good-overlap');
                        }
                    }

                    trackDiv.appendChild(slot);
                }
                grid.appendChild(trackDiv);
            });
        }

        function selectTime(hourIndex) {
            selectedHour = hourIndex;
            renderGrid(); // Re-render to show selection
            updateMeetingDetails(hourIndex);
        }

        function updateMeetingDetails(hourIndex) {
            const dateStr = document.getElementById('meetingDate').value;
            const baseDate = DateTime.fromISO(dateStr).set({ hour: hourIndex });

            // Show times for all zones
            let timeText = `Selected Time: ${baseDate.toFormat('ffff')}<br><br>`;
            timeText += activeZones.map(z => {
                const zTime = baseDate.setZone(z.zone);
                return `<strong>${z.name}</strong>: ${zTime.toFormat('h:mm a')}`;
            }).join(' | ');

            document.getElementById('selectedTimeText').innerHTML = timeText;
            document.getElementById('meetingPanel').style.display = 'block';
        }

        function exportPDF() {
            const element = document.getElementById('plannerContainer');
            const title = document.getElementById('meetingTitle').value || 'Meeting Schedule';
            const link = document.getElementById('meetingLink').value;

            // Create a temporary container with title and link for the PDF
            const pdfContent = document.createElement('div');
            pdfContent.style.padding = "20px";

            const header = document.createElement('h2');
            header.textContent = title;
            header.style.color = "#0d9488";
            pdfContent.appendChild(header);

            if (link) {
                const sub = document.createElement('p');
                sub.innerHTML = `<strong>Link:</strong> <a href="${link}">${link}</a>`;
                pdfContent.appendChild(sub);
            }

            const details = document.createElement('div');
            details.innerHTML = document.getElementById('selectedTimeText').innerHTML;
            details.style.marginBottom = "20px";
            pdfContent.appendChild(details);

            // Clone grid
            const gridClone = document.getElementById('zoneGrid').cloneNode(true);
            pdfContent.appendChild(gridClone);

            const opt = {
                margin: 0.5,
                filename: 'meeting-schedule.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
            };

            html2pdf().set(opt).from(pdfContent).save();
        }

    </script>
</body>

</html>